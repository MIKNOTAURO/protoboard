{% extends "activitytree/base.html" %}


{% block style %}

/*
 * Editor
 */

    #editor {

        height: 250px;

    }


{% endblock style %}


{% block content %}



    <h3> Ordena la lista</h3>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Editor</h3>

        </div>

        <div class="panel-body">
            <div id="editor">
                # Funcion que ordena una lista, puedes utilizar sort()
                def solution():
                pass
            </div>
        </div>
    </div>

    <button id="send_btn_queue" type="button" class="btn btn-primary"> Enviar a la Cola</button>

    <div id="info_panel" class="panel panel-default">
        <div id="info_panel_heading" class="panel-heading">
            <h3 class="panel-title">Instrucciones</h3>
        </div>

        <div id="info_panel_body" class="panel-body">

            <p>Escribe una función llamada solution la cual reciba como parámetro
                una lista y regrese la lista ordenada.</p>
            <p>En caso de recibir como parámetro el valor None debe regresar una lista vacía. </p>
            <code>
                <p>>>> solution([4,3,5,1])</p>
                <p>[1, 3, 4, 5]</p>
                <p>>>> solution(None)</p>
                <p>[]</p>
            </code>




        </div>



    </div>






{% endblock content %}



{% block scripts %}



    <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {

            task_id = 0;
            number_of_tries = 0;


            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }





            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                crossDomain: false, // obviates need for sameOrigin test
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type)) {
                        var csrftoken = getCookie('csrftoken');


                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });




     $("#send_btn_queue").on("click", function (){
           var code = editor.getValue();

           // alert(code);

           $.ajax(
                {
                    url: '/execute_queue',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({"jsonrpc": "2.0", "method": "_execute", "params": [code], "id": 1 }),
                    dataType: "json",
                    success: function(data, textStatus, jqXHR) {

                            task_id =data.id;
                            number_of_tries=0;

                        $("#info_panel_body").html("");

                         $('<p>'+ 'En proceso...'+'<p/>', {class:"p"}).appendTo("#info_panel_body");

                        poll();

                     },
                    error: function(jqXHR, textStatus, errorThrown) {
                        alert ("Error:" + textStatus+" "+errorThrown+" "+jqXHR.responseText);}
                });


     });


    function poll(){
        $.ajax({ url: '/get_result',
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({"jsonrpc": "2.0", "method": "_execute", "params": [null], "id": task_id }),
            success: function(data){
            //Update your dashboard gauge
            number_of_tries++;
              $("#info_panel_body").html("");
                    if (data.outcome != -1)
                    {
                        var info_list = data.result;
                        for (var i=0; i<info_list.length; i++){
                         $('<p>'+ info_list[i]+'<p/>', {class:"p"}).appendTo("#info_panel_body");
                        }
                    }
                    else
                    {

                    }
            console.log(data.outcome);

            }, dataType: "json",

            complete: function (jqXHR,textStatus ){
               var data = $.parseJSON(jqXHR.responseText);
               console.log(data.outcome);
               console.log(data);
               if (data.outcome == -1)
               {
                   if (number_of_tries < 150)
                   {
                       poll();
                   }

                   else
                   {
                        $("#info_panel_body").html("");
                        $('<p>'+ 'TIME OUT'+'<p/>', {class:"p"}).appendTo("#info_panel_body");

                   }
               }
            },
            timeout: 5000 });
    };

  });

</script>

   <script src="{{ MEDIA_URL }}js/ace.js" type="text/javascript" charset="utf-8"></script>
   <script src="{{ MEDIA_URL }}js/theme-chrome.js" type="text/javascript" charset="utf-8"></script>
   <script src="{{ MEDIA_URL }}js/mode-python.js" type="text/javascript" charset="utf-8"></script>
   <script type="text/javascript" charset="utf-8">
        editor = ace.edit("editor");
        editor.setTheme("ace/theme/chrome");
        editor.getSession().setMode("ace/mode/python");

   </script>




{% endblock scripts %}